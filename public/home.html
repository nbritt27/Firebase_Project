<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Home Tab</title>
  <link rel="stylesheet" href="resetstyle.css">
  <link rel="stylesheet" href="home.css">
  <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyDsmkVyaN9_BhUnzUjqtilAM8FDr1Ccndo",
      authDomain: "test-project-a8dd5.firebaseapp.com",
      databaseURL: "https://test-project-a8dd5.firebaseio.com",
      projectId: "test-project-a8dd5",
      storageBucket: "test-project-a8dd5.appspot.com",
      messagingSenderId: "1066619119347"
    };
    firebase.initializeApp(config);
  </script>
  <script type="text/javascript">
    var userRef;
    var currentposts = {};
    initApp = function () {
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // User is signed in.
          userRef = user;
          var database = firebase.database();
          var displayName = user.displayName;
          this.userPic = document.getElementById('user-pic');
          var email = user.email;
          var emailVerified = user.emailVerified;
          var photoURL = user.photoURL;
          var uid = user.uid;
          var phoneNumber = user.phoneNumber;
          var providerData = user.providerData;
          var userAge = user.age;
          var userBio = user.bio
          this.userPic.src = photoURL;
          database.ref().child('users' + uid).set({
            username: displayName,
            email: email,
            profile_picture: photoURL,
            age: userAge,
            bio: userBio
          });
          //console.log("Trying to add the data");
          user.getIdToken().then(function (accessToken) {
            document.getElementById('sign-in-status').textContent = 'Signed in';
            document.getElementById('sign-in').textContent = 'Sign out';
            document.getElementById('account-details').textContent = JSON.stringify({
              displayName: displayName,
              email: email,
              emailVerified: emailVerified,
              phoneNumber: phoneNumber,
              photoURL: photoURL,
              uid: uid,
              accessToken: accessToken,
              providerData: providerData
            }, null, '  ');
          });
        } else {
          // User is signed out.
          document.getElementById('sign-in-status').textContent = 'Signed out';
          document.getElementById('sign-in').textContent = 'Sign in';
          document.getElementById('account-details').textContent = 'null';
        }
      }, function (error) {
        console.log(error);
      });
    };
    window.addEventListener('load', function () {
      initApp();
      loadFeed();
      //console.log(document.getElementById("ageText").value);
    });
    function loadFeed() {
      console.log("running loadFeed");
      removeFeedNodes();
      //var postContainer = document.getElementById("postContainer");
      var leadsRef = firebase.database().ref().child('posts');
      leadsRef.on('value', function (snapshot) {
        removeFeedNodes();
        var postContainer = document.createElement('div');
        postContainer.id = "postContainer";
        snapshot.forEach(function (childSnapshot) {
          var childData = childSnapshot.val();
          //console.log(childData);
          var postDiv = document.createElement('div');
          postDiv.id = "postDiv";
          var userInfo = document.createElement("div");
          userInfo.id = "userInfo";
          postDiv.appendChild(userInfo);
          var postData = document.createElement("div");
          postData.id = "postData";
          var userPicture = document.createElement("img");
          userPicture.id = "user-feed-pic";
          userPicture.src = childData["picturesrc"];
          userInfo.appendChild(userPicture);
          var userLabel = document.createElement("h2");
          userLabel.id = "userLabel";
          userLabel.innerHTML = childData["author"];
          userInfo.appendChild(userLabel);
          var titleText = document.createElement("h1");
          titleText.id = "titleElement";
          titleText.innerHTML = childData["title"];
          postData.appendChild(titleText);
          var bodyText = document.createElement("p");
          bodyText.id = "bodyElement";
          bodyText.innerHTML = childData["body"];
          var postedDate = document.createElement("p");
          postedDate.id = "datePosted";
          var month = parseDate(childData["date"]).getMonth() + 1;
          var day = parseDate(childData["date"]).getDate();
          var year = parseDate(childData["date"]).getFullYear();
          postedDate.innerHTML = month.toString() + "/" + day.toString() + "/" + year.toString();
          userInfo.appendChild(postedDate);
          var likeButton = document.createElement("button");
          likeButton.id = "likeButton";
          likeButton.innerHTML = ":)";
          try {
            if (childData["numLikes"] == null) {
              currentposts[childData["postId"]] = 0;

            }
            else {
              currentposts[childData["postId"]] = childData["numLikes"];
            }

          }
          catch (error) {
            console.log("Error message in loadfeed is " + error);
            currentposts[childData["postId"]] = 1;
          }
          likeButton.addEventListener("click", function () { likePost(childData["postId"]) });
          var likeText=document.createElement("p");
          likeText.id="likeText";
          try {
            if (childData["numLikes"] == null) {
              likeText.innerHTML="0"

            }
            else {
              likeText.innerHTML=childData["numLikes"];
            }

          }
          catch (error) {
            console.log("Error message in loadfeed is " + error);
            likeText.innerHTML="0"
          }
        
          console.log("post id is equal to: " + childData["postId"]);

          postData.appendChild(bodyText);
          
          postData.appendChild(likeButton);
          postData.appendChild(likeText);

          postDiv.appendChild(userInfo);
          postDiv.appendChild(postData);
          postContainer.prepend(postDiv);
          document.body.appendChild(postContainer);
        });
      });
    }
    function likePost(postId) {

      console.log("running likepost");
      //console.log(firebase.database().ref().orderByChild());

      var leadsRef = firebase.database().ref().child('posts').child(postId.toString());

      console.log(currentposts[postId]);
      try {
        likeData = {
          numLikes: 1 + currentposts[postId.toString()]
        }
        currentposts[postId] = currentposts[postId.toString()] + 1;

      }


      catch (error) {
        console.log("Ran into an error and the error is that " + error);
        likeData = {
          numLikes: 1
        }
        currentposts[postId] = 1;

      }
      firebase.database().ref().child('posts').child(postId).update(likeData);

    }


    function checkForTags(inputText, postInfo, postKey) {
      console.log(inputText);
      for (var i = 0; i < inputText.length; i++) {
        if (inputText[i][0] == "@") {
          console.log("Found a tag at " + i);
          var tagName = inputText[i].substring(1, inputText[i].length);
          console.log("The tag name is: " + tagName);
          var leadsRef = firebase.database().ref().child('groups');
          //console.log(leadsRef.val());
          leadsRef.on('value', function (snapshot) {
            snapshot.forEach(function (childSnapshot) {
              var childData = childSnapshot.val();
              //console.log("data says a tag is " + childData["tag"]);
              if (childData["tag"] == tagName) {
                //console.log ("This is referring to a post with id " + childData["id"]);
                firebase.database().ref().child('groups/' + childData["id"] + '/posts/' + postKey).update(postInfo);
              }
            });
          });
        }
      }
      window.reload();
    }
    function parseDate(input) {
      var parts = input.match(/(\d+)/g);
      // new Date(year, month [, date [, hours[, minutes[, seconds[, ms]]]]])
      return new Date(parts[0], parts[1] - 1, parts[2]); // months are 0-based
    }
    function removeFeedNodes() {
      while (true) {
        try {
          document.body.removeChild(document.getElementById("postContainer"));
        }
        catch (error) {
          console.log("found an error");
          break;
        }
      }
      /*
      console.log("Trying to remove feeds");
      while(true){
        try {
          console.log("Existing element: " + document.getElementById("postDiv"));
          document.body.removeChild(document.getElementById("postDiv"));
        } catch (error) {
          break;
        }
      }
      */
    }
    var addGroupPresent = false;
    function writeNewGroup(title, description, tag) {
      //console.log("Trying to write new post");
      document.body.removeChild(document.getElementById("titleLabel"));
      document.body.removeChild(document.getElementById("titleText"));
      document.body.removeChild(document.getElementById("bodyLabel"));
      document.body.removeChild(document.getElementById("bodyText"));
      document.body.removeChild(document.getElementById("tagLabel"));
      document.body.removeChild(document.getElementById("tagText"));
      document.body.removeChild(document.getElementById("submitButton"));
      addGroupPresent = false;
      // A post entry.
      // Get a key for a new Post.
      var newPostKey = firebase.database().ref().child('groups').push().key;
      var postData = {
        description: description,
        title: title,
        tag: tag,
        date: new Date(),
        id: newPostKey
      };
      // Write the new post's data simultaneously in the posts list and the user's post list.
      var updates = {};
      updates['/groups/' + newPostKey] = postData;
      firebase.database().ref().child('groups/' + newPostKey).update(postData);
    }
    function addGroup() {
      if (!addGroupPresent) {
        var titleLabel = document.createElement("h3");
        titleLabel.innerHTML = "Title: "
        document.body.appendChild(titleLabel);
        titleLabel.id = "titleLabel";
        var titleText = document.createElement("input");
        document.body.appendChild(titleText);
        titleText.id = "titleText";
        var bodyLabel = document.createElement("h3");
        bodyLabel.innerHTML = "Description: "
        document.body.appendChild(bodyLabel);
        bodyLabel.id = "bodyLabel";
        var bodyText = document.createElement("input");
        document.body.appendChild(bodyText);
        bodyText.id = "bodyText";
        var tagLabel = document.createElement("h3");
        tagLabel.innerHTML = "Tag: "
        document.body.appendChild(tagLabel);
        tagLabel.id = "tagLabel";
        var tagText = document.createElement("input");
        document.body.appendChild(tagText);
        tagText.id = "tagText";
        var submitButton = document.createElement("button");
        submitButton.innerHTML = "Post";
        document.body.appendChild(submitButton);
        submitButton.onclick = 'function () { writeNewGroup(document.getElementById("titleText").value, document.getElementById("bodyText").value, document.getElementById("tagText").value) }';
        submitButton.id = "submitButton";
        addGroupPresent = !addGroupPresent;
      }
    }
    function writeNewPost(uid, uname, pic, heading, text) {
      //console.log("Trying to write new post");
      /*document.body.removeChild(document.getElementById("titleLabel"));
      document.body.removeChild(document.getElementById("titleText"));
      document.body.removeChild(document.getElementById("bodyLabel"));
      document.body.removeChild(document.getElementById("bodyText"));
      document.body.removeChild(document.getElementById("submitButton"));
      addPostPresent = false;*/
      // A post entry.
      var modal = document.getElementById('myModal').style.display = "none";
      var title = document.getElementById('titleText').value = "";
      var text = document.getElementById('bodyText').value = "";
      var newPostKey = firebase.database().ref().child('posts').push().key;

      var postData = {
        author: uname,
        uid: uid,
        body: text,
        title: heading,
        date: new Date(),
        picturesrc: pic,
        postId: newPostKey
      };
      // Get a key for a new Post.
      // Write the new post's data simultaneously in the posts list and the user's post list.
      var updates = {};
      updates['/posts/' + newPostKey] = postData;
      updates['/user-posts/' + uid + '/' + newPostKey] = postData;
      firebase.database().ref().child('posts/' + newPostKey).update(postData);
      firebase.database().ref().child('user-posts/' + uid + '/' + newPostKey).update(postData);
      checkForTags(text.split(" "), postData, newPostKey);
    }
    var addPostPresent = false;
    function addPost() {
      if (addPostPresent) {
        console.log("Add box already present.");
      } else {
        var titleLabel = document.createElement("h3");
        titleLabel.innerHTML = "Title: "
        document.body.appendChild(titleLabel);
        titleLabel.id = "titleLabel";
        var titleText = document.createElement("input");
        titleText.maxLength = "30";
        document.body.appendChild(titleText);
        titleText.id = "titleText";
        var bodyLabel = document.createElement("h3");
        bodyLabel.innerHTML = "Body: "
        document.body.appendChild(bodyLabel);
        bodyLabel.id = "bodyLabel";
        var bodyText = document.createElement("input");
        bodyText.maxLength = "280";
        document.body.appendChild(bodyText);
        bodyText.id = "bodyText";
        var submitButton = document.createElement("button");
        submitButton.innerHTML = "Post";
        document.body.appendChild(submitButton);
        submitButton.onclick = function () { writeNewPost(userRef.uid, userRef.displayName, userRef.photoURL, document.getElementById("titleText").value, document.getElementById("bodyText").value) };
        submitButton.id = "submitButton";
        addPostPresent = !addPostPresent;
      }
    }
  </script>
</head>

<body>
  <nav class="nav-login">
    <ul>
      <li><a href="home.html">Home</a></li>
      <li><a href="groups.html">Groups</a></li>
      <li><a href="#">Contact</a></li>
      <li><a href="login.html">Profile</a></li>

      <li>
        <div id="firebaseui-auth-container"></div>
      </li>
      <li>
        <div><img id="user-pic"
            src="https://cdn4.iconfinder.com/data/icons/forum-buttons-and-community-signs-1/794/profile-3-512.png"
            style="  width: 40px;height: 40px;background-size: 40px;border-radius: 20px; right: 10px; top: 10px;"></div>
      </li>
    </ul>
  </nav>

  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <button type="button" id="addPost">Add Post</button>
  <button type="button" onclick="loadFeed()">Refresh Feed</button>
  <button type="button" onclick="addGroup()">Create Group</button>

  <br>
  <div id="postContainer"></div>

  <!-- The Modal -->
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2>Add Post</h2>
      </div>
      <div class="modal-body">
        <h3 id="titleLabel">Title:</h3>
        <input id="titleText" type="text" name="" value="">
        <h3 id="bodyLabel">Body:</h3>
        <input id="bodyText" type="text" name="" value="">
        <button id="submitButton" type="button">Post It!</button>
      </div>
    </div>

<script>
// Get the modal
var modal = document.getElementById('myModal');

// Get the button that opens the modal
var btn = document.getElementById("addPost");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

var submit = document.getElementById('submitButton');
submit.onclick = function() {
  console.log("Submitting post.");
  writeNewPost(userRef.uid, userRef.displayName, userRef.photoURL, document.getElementById("titleText").value, document.getElementById("bodyText").value)
}
</script>
</body>

</html>