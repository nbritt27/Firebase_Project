<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Home Tab</title>
    <link rel="stylesheet" href="resetstyle.css">
    <link rel="stylesheet" href="home.css">
    <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
    <script>
            // Initialize Firebase
            var config = {
              apiKey: "AIzaSyDsmkVyaN9_BhUnzUjqtilAM8FDr1Ccndo",
              authDomain: "test-project-a8dd5.firebaseapp.com",
              databaseURL: "https://test-project-a8dd5.firebaseio.com",
              projectId: "test-project-a8dd5",
              storageBucket: "test-project-a8dd5.appspot.com",
              messagingSenderId: "1066619119347"
            };
            firebase.initializeApp(config);
          </script>
     <script type="text/javascript">
       var userRef;
       initApp = function() {
         firebase.auth().onAuthStateChanged(function(user) {
           if (user) {
             // User is signed in.
             userRef=user;

             var database=firebase.database();
             var displayName = user.displayName;
             this.userPic = document.getElementById('user-pic');

             var email = user.email;
             var emailVerified = user.emailVerified;
             var photoURL = user.photoURL;
             var uid = user.uid;
             var phoneNumber = user.phoneNumber;
             var providerData = user.providerData;
             var userAge=user.age;
             var userBio=user.bio
             this.userPic.src = photoURL;
             database.ref().child('users'+uid).set({
             username: displayName,
             email: email,
             profile_picture : photoURL,
             age: userAge,
             bio: userBio
   });
             //console.log("Trying to add the data");
             user.getIdToken().then(function(accessToken) {
               document.getElementById('sign-in-status').textContent = 'Signed in';
               document.getElementById('sign-in').textContent = 'Sign out';
               document.getElementById('account-details').textContent = JSON.stringify({
                 displayName: displayName,
                 email: email,
                 emailVerified: emailVerified,
                 phoneNumber: phoneNumber,
                 photoURL: photoURL,
                 uid: uid,
                 accessToken: accessToken,
                 providerData: providerData
               }, null, '  ');
             });



           } else {
             // User is signed out.
             document.getElementById('sign-in-status').textContent = 'Signed out';
             document.getElementById('sign-in').textContent = 'Sign in';
             document.getElementById('account-details').textContent = 'null';
           }

         }, function(error) {
           console.log(error);
         });


       };

       window.addEventListener('load', function() {

         initApp();

        loadFeed();

         //console.log(document.getElementById("ageText").value);
       });

        function loadFeed(){
            console.log("running loadFeed");
            removeFeedNodes();

            var postContainer = document.getElementById("postContainer");

            var leadsRef = firebase.database().ref().child('posts');
            leadsRef.on('value', function(snapshot) {
              removeFeedNodes();
              snapshot.forEach(function(childSnapshot) {
                var childData = childSnapshot.val();
                console.log(childData);
                var postDiv=document.createElement('div');
                postDiv.id="postDiv";

                var userInfo = document.createElement("div");
                userInfo.id = "userInfo";
                postDiv.appendChild(userInfo);

                var postData = document.createElement("div");
                postData.id = "postData";
                postDiv.appendChild(postData);

                var userPicture=document.createElement("img");
                userPicture.id="user-feed-pic";
                userPicture.src=childData["picturesrc"];
                userInfo.appendChild(userPicture);

                var userLabel=document.createElement("h2");
                userLabel.id="userLabel";
                userLabel.innerHTML=childData["author"];
                userInfo.appendChild(userLabel);

                var titleText=document.createElement("h1");
                titleText.id="titleElement";
                titleText.innerHTML=childData["title"];
                postData.appendChild(titleText);

                var bodyText=document.createElement("p");
                bodyText.id="bodyElement";
                bodyText.innerHTML=childData["body"];
                postData.appendChild(bodyText);
                document.body.appendChild(postDiv);
                postContainer.appendChild(postDiv);
                document.body.appendChild(postContainer);


              //console.log(childData["body"])
              });
            });
          }



        function removeFeedNodes(){
          while(true){
            try {
              console.log(document.getElementById("postdiv"));
              document.body.removeChild(document.getElementById("postdiv"));

            } catch (error) {
              break;
            }
          }


        }
        function writeNewPost(uid, uname, pic, heading, text) {
            //console.log("Trying to write new post");
            document.body.removeChild(document.getElementById("titleLabel"));
            document.body.removeChild(document.getElementById("titleText"));
            document.body.removeChild(document.getElementById("bodyLabel"));
            document.body.removeChild(document.getElementById("bodyText"));
            document.body.removeChild(document.getElementById("submitButton"));
            // A post entry.

            var postData = {
                author: uname,
                uid: uid,
                body: text,
                title: heading,
                date: new Date(),
                picturesrc: pic
            };

            // Get a key for a new Post.
            var newPostKey = firebase.database().ref().child('posts').push().key;

            // Write the new post's data simultaneously in the posts list and the user's post list.
            var updates = {};
            updates['/posts/' + newPostKey] = postData;
            updates['/user-posts/' + uid + '/' + newPostKey] = postData;

            firebase.database().ref().child('posts/'+newPostKey).update(postData);
            firebase.database().ref().child('user-posts/'+uid+'/'+newPostKey).update(postData);
            removeFeedNodes();

        }



       function addPost(){

         //console.log("Trying to add post");
         var titleLabel=document.createElement("h3");
         titleLabel.innerHTML="Title: "
         document.body.appendChild(titleLabel);
         titleLabel.id="titleLabel";

         var titleText=document.createElement("input");
         document.body.appendChild(titleText);
         titleText.id="titleText";

         var bodyLabel=document.createElement("h3");
         bodyLabel.innerHTML="Body: "
         document.body.appendChild(bodyLabel);
         bodyLabel.id="bodyLabel";

         var bodyText=document.createElement("input");
         document.body.appendChild(bodyText);
         bodyText.id="bodyText";

         var submitButton=document.createElement("button");
         submitButton.innerHTML="Post";
         document.body.appendChild(submitButton);

         submitButton.onclick=function(){writeNewPost(userRef.uid, userRef.email, userRef.photoURL, document.getElementById("titleText").value, document.getElementById("bodyText").value)};

         submitButton.id="submitButton";
       }
     </script>
</head>
<body>
    <nav class="nav-login">
            <ul>
                <li><a href="home.html">Home</a></li>
                <li><a href="groups.html">Groups</a></li>
                <li><a href="#">Contact</a></li>
                <li><a href="login.html">Profile</a></li>

                <li><div id="firebaseui-auth-container"></div></li>
                <li><div><img id="user-pic" src="https://cdn4.iconfinder.com/data/icons/forum-buttons-and-community-signs-1/794/profile-3-512.png" style="  width: 40px;height: 40px;background-size: 40px;border-radius: 20px; right: 10px; top: 10px;"></div></li>
            </ul>
            </nav>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <button type="button" onclick="addPost()">Add Post</button>
    <button type="button" onclick="loadFeed()">Refresh Feed</button>
    <div id="postContainer"></div>
</body>
</html>
